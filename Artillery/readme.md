\usepackage{amsmath}

# Разработка систем на основе PostgreSQL

#### Стек
1. Операционная система: [`Linux`](https://ubuntu.com/download/desktop), [`Docker`](https://docs.docker.com/get-started/get-docker/)
2. СУБД: [`PostgreSQL`](https://www.postgresql.org/download/) , [`postgrest`](https://docs.postgrest.org/en/v12/)


## Легенда
> Вы включены в команду целью которой состоит в разработке базы данных и **Backend** для системы подготовки метрологических данных в рамках разработки ПАК (Программно-аппаратного комплекса) согласно [**Технического задания**](./_Docs/TechnicalTask.md).<br><br>
> `Основаня задача команды` - это разработать решение которое должно соответствовать следующим критериям:<br>
>   * Решение должно работать в режиме как `SINGLE-USER` так и `MULTI-USER`
>   * В режиме `MULTI-USER`, количество одновременных пользователей до **50 000**
>   * Требуется обеспечить максимальную производительность при минимально производительном оборудовании
>   * Необходимо обеспечить максимально гибкий и простой вариант загрузки справочников и таблиц стрельбы

## Занятия
###  Подготовка (`Занятие 1`)
> Цель: Ознакомить слушателей с основными элементами SQL. 

1. [Запускаем Postgres в Docker среде](./_Infra)
- Принципы ACID (Принципы ACID предоставили разработчикам и пользователям стандартизированный подход к пониманию и обеспечению надёжности транзакций)
<br>

**Atomicity (Атомарность)** - Транзакция должна выполняться целиком либо не выполняться вовсе.<br>
**Consistency (Целостность)** - После завершения транзакции данные должны быть согласованными.<br>
**Isolation (Изолированность)** - Одновременно выполняющиеся транзакции не должны влиять друг на друга. <br>
**Durability (Долговечность)** - После завершения транзакции результаты должны быть сохранены и иметь возможность восстановиться после сбоя <br>

2. Краткий теоретический материал
```
DDL, DML, DCL, TCL
```

**DDL** - Data Definition Language, управление структурой базы данных <br>
**DML** - Data Manipulation Language, управление данными <br>
**DCL** - Data Control Language. управление доступом <br>
**TCL** - Transaction Control Language, управление транзакциями <br>

3. Создаем пробные таблицы. Учимся работать с `DDL` командами
4. Добавляем пробные записи. Учимся работать с `DML` командами

**Задание**
> Самостоятельно при прмощи команд DDL создать структуру базы данных для текущего решения. <br>
> История измерений, Набор параметров, Типы измерителей <br>

5. Создаем локально базу данных `Meteo11`
	* measurment_params
	* measurment_types
	* measurement_batch
 

6. Начало работы с PgSQL. Пакетные скрипты 


**Задание:**
> Необходимо по аналогии добавить различные данные в таблицу `measurment_types` в том числе с одинаковым кодом.
> Удалить лишние данные. Оставить только две исходные записи.
> Скрипт с заданием сохранить в виде файла.

7. Подключаем `sequences`

**Задание:**
> Необходимо выполнить вставку данных в таблицы `measurement_batch`, `measurment_params`. Далее, удалить и убедится, что `sequences` назначили новый код.
> Убрать `DEFAULT` значение в таблицах. Удалить `sequences`, создать заново и привязать
> Скрипт с заданием сохранить в виде файла.

8. Подключаем внешние ключи

**Задание:**
> Необходимо заполнить данными таблицу `measurment_params` с учетом связей.
> Необходимо через UI удалить связь между таблицей `fk_measurment_param_measurement_batch_id`. Далее, вставить некорректные данные в таблицу `measurment_params`
> Заново попробовать создать связь. Заменить некорреткные данные на `null` и создать связь.

#### Домашнее задание
1. Создать таблицу для учета пользователей системы. Предусмотреть справочник военных должностей. 
2. Изменить таблицу `measurement_batch` изменить поле `metrologist`. Сделать связь со справочником пользователей.
3. Оформить решение в виде скрипта и приложить `Screenshot` решения.


### Интерполяция (`Занятие 2`)
> Цель: Ознакомить слушателей с основными приемами разработки pgSQL и реализовать функцию линейной интерполяции
1. Согласно [технического задания](./_Docs/TechnicalTask.md) необходимо разработать разработать алгоритм линейной интерполяции.
2. Добавим новую таблицу со справочником виртуальным поправок на температуру `calc_temperatures_correction` - **Таблица 1**
3. Создадим SQL запрос для расчета интерполяции по таблице `calc_temperatures_correction`. 
Формула:
> $D = X_{1} - X_{0}$ <br>
> $Result = (X - X_{0}) * (Y_{1} - Y_{0}) / D + Y_{0}$ <br>

Где:
 - $X_{1}$ - правая часть значения
 - $X_{0}$ - левая часть значения 
 - $Y_{1}$ - правая чась поправки
 - $Y_{0}$ - левая часть поправки

**Задание:**
> Написать SQL запрос для получение $X_{1}$,  $X_{0}$,  $Y_{1}$ ,  $Y_{0}$ <br>
> Написать SQL запрос расчета линейной интерполяции <br>

3. Добавим функцию для расчета линейной интерполяции.
4. Меняем SQL запрос для получения  $X_{1}$,  $X_{0}$,  $Y_{1}$ ,  $Y_{0}$ с использованием функции.

**Задание**
> Добавить в функцию проверку аргументов. $X > X_{0} < X_{1}$ <br>
> $D$ - должно быть больше > 0 <br>
> Провери должны формировать [raise error](https://www.postgresql.org/docs/current/plpgsql-errors-and-messages.html)

5. Создаем собственный тип данных. 

**Задание:**
> Создать функцию `fn_calc_temperatures_correction` с использованием типа `interpolation_batch`  <br>
> Изменить текущую реализацию текущей функции `fn_calc_temperatures_correction` <br>

6. Работа с циклами. Создадим pgSQL скрипт который будет выводить в цикла сообщение 

**Задание:**
1. Написать pgSQL срипт для расчета интерполяции на всем диаппазоне температур с шагом **0.1 С**


#### Домашнее задание
1. Создать таблицу с настройками для проверки входных данных `measure_settings`
 В рамках данной таблицы нужно хранить **все** `константы`
- `Температура`. Минимальное значение **-58**, максимальное **58**, указывается в цельсиях
- `Давления`.  Минимальное значение **500**, максимальное **900**, указывается в мм рт ст
- `Направление ветра`. Минимальное значение **0**,максимальное значение **59** <br>
  и т.д.

2. Создать собственный тип данных для передачи входных параметров 
3. Написать собственную функцию на вход должны подаваться входные параметры, а на выходе собственный тип данных.
4. Функция должна проверять входные параметры. 
При нарушении граничных параметров формировать [raise error](https://www.postgresql.org/docs/current/plpgsql-errors-and-messages.html)

###  Приближенный (`Занятие 3`)
> Цель: Реализовать расчет данных заголовка Метео-11
1. Создаем SQL функцию для преобразования даты времени в строковое значение `ДДЧЧММ` 


**Задание:**
> Измеить функцию. Добавить проверку по дню < 10 и минуты < 10.

2. Создаем SQL функция для расчета `ВВВВ` - высота расположения метеопоста над уровнем моря. Добавить все проверки и ограничения.
3. Добавляем данные в таблицу `measurment_settings`
4. Создаем функцию для расчета `Отклонение наземной виртуальной температуры от табличного` ($ΔT_{0}^{мп}$) - fn_calc_temperature

**Задание:**
> Создать функцию для расчета отклонения наземного давления $ΔНо$ - `fn_calc_pressure`<br>
> Написать pgSQL который выполнит вычисления `отклонения наземного давления ($ΔНо$)` и `отклонение наземной виртуальной температуры от табличного ($ΔT_{0}^{мп}$)` по данным
> из таблицы measurment_params <br> 


#### Домашнее задание
1. Создать функцию которая сформирует заголовок в формте `ДДЧЧМ ВВВВ БББТТ` согласно техническому заданию <br>
2. Написать `pgSQL` скрипт для проверки работы данной функции. Примеры брать из [технического задания](./_Docs/TechnicalTask.md)

###  Подготовка к расчетам (`Занятие 4`)
> Цель: Подготовить таблицы и структуры для дальнейшей реализации расчетов Метео-11
1. Создадим таблицу для описания списка высот `calc_heights`
2. Создадим таблицу `calc_temperatures` (**Таблица 1**) для хранения информации о [среднем отклонении температуры воздуха](./_Docs/AlgoritmDmk.md)

**Задание:**
> Дописать скрипт для добавления записей в таблицу `calc_temperatures`. Положительные и отрицательные значения. <br>
> Написать SQL запрос на удаление любой высоты. Продемонстрировать результат.<br>
> Написать SQL скрипт для создания связки данной таблицы с таблицей описывающих типы устройств `measurment_types`

3. Формируем запрос для построения отчета: `Статистика по измерениям`. Отчет должен выводить информацию в следующем виде:

| ФИО            | Звание           | Количество измерений   | Количество ошибочных измерений |
|----------------|------------------|------------------------|--------------------------------|

**Задание:**
> Изменить запрос для отчета. Включить в запрос CTE и функцию для проверки входных данных.
> Создать на основе данного запрос представление (view)

4. Создадим набор таблиц для описания `среднего отклонения температуры воздуха` (Таблица 2) для Ветрового ружья. Создадим 
отдельную таблицу для высот и для заголовка. Сделаем связи и заполним данными.
Теоретический материал: [нормализация базы данных](https://learn.microsoft.com/ru-ru/office/troubleshoot/access/database-normalization-description)
4. Создадим PgSQL скрипт который будет считывать данные их Таблицы 2 и выводить их на консоль `raise notice`



#### Домашнее задание
1. Создать таблицу для учета [`Скорости среднего ветра`](./Docs/AlgoritmBp.md)(**Таблица 3**) для расчета с помощью ветрового ружья
2. Написать новый отчет и оформить его в виде View и использованием CTE. **Самая эффективная высота измерения**

| ФИО  | Звание | Мин. высота метеопоста | Макс. высота метепоста | Всего измерений | Из них ошибочны |
|------|--------|------------------------|------------------------|-----------------|-----------------|

Необходмо вывести список пользователей у которых меньше **10 ошибок** в наборе данных, которые делали не менее **5-ти** измерения
Ошибку определеять обязательно с использованием функции проверки корректности.
3. Написать отдельный `pgSQL` скрипт, который сформирует тестовые данные. 
Нужно добавить несколько пользователей в таблицу `emploees`, а так же не менее **100 измерений** с разными параметрами для каждого пользователя. 
Для указания высоты, давления, температуры использовать функцию `random()`. Для создания скрипта использовать циклы. 







 
 

